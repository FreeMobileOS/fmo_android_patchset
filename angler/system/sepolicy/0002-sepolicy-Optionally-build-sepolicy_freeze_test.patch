From a06a2fefd89a5297ad6baf7968032dacde39e1a7 Mon Sep 17 00:00:00 2001
From: Nick Reuter <nreuter85@gmail.com>
Date: Mon, 6 Aug 2018 22:48:20 -0500
Subject: [PATCH 2/2] sepolicy: Optionally build sepolicy_freeze_test

 * Disable sepolicy_freeze_test unless the variable
    PLATFORM_SEPOLICY_VERSION_TEST is set to true

 * Needed to modify public sepolicy rules, example:
    "Files system/sepolicy/prebuilts/api/28.0/public/name.te
    and system/sepolicy/public/name.te differ"

Change-Id: I8a333d492d0c2953ff35e81600dd7fe316f608ec
Signed-off-by: Adrian DC <radian.dc@gmail.com>
Signed-off-by: Satish Patel <tosatishpatel@gmail.com>
---
 Android.mk | 12 ++++++++++++
 1 file changed, 12 insertions(+)

diff --git a/Android.mk b/Android.mk
index dadd7b0..65fb8fb 100644
--- a/Android.mk
+++ b/Android.mk
@@ -319,6 +319,14 @@ endif
 LOCAL_REQUIRED_MODULES += \
     userdebug_plat_sepolicy.cil \
 
+ifneq ($(PLATFORM_SEPOLICY_VERSION),$(TOT_SEPOLICY_VERSION))
+ifeq ($(PLATFORM_SEPOLICY_VERSION_TEST),true)
+LOCAL_REQUIRED_MODULES += \
+    sepolicy_freeze_test
+
+endif # ($(PLATFORM_SEPOLICY_VERSION_TEST),true)
+endif # ($(PLATFORM_SEPOLICY_VERSION),$(TOT_SEPOLICY_VERSION))
+
 include $(BUILD_PHONY_PACKAGE)
 
 #################################
@@ -1367,6 +1375,10 @@ $(LOCAL_BUILT_MODULE): $(all_frozen_files)
 ifneq ($(PLATFORM_SEPOLICY_VERSION),$(TOT_SEPOLICY_VERSION))
 	@diff -rq -x bug_map $(PRIVATE_BASE_PLAT_PUBLIC_PREBUILT) $(PRIVATE_BASE_PLAT_PUBLIC)
 	@diff -rq -x bug_map $(PRIVATE_BASE_PLAT_PRIVATE_PREBUILT) $(PRIVATE_BASE_PLAT_PRIVATE)
+ifeq ($(PLATFORM_SEPOLICY_VERSION_TEST),true)
+	@diff -rq $(PRIVATE_BASE_PLAT_PUBLIC_PREBUILT) $(PRIVATE_BASE_PLAT_PUBLIC)
+	@diff -rq $(PRIVATE_BASE_PLAT_PRIVATE_PREBUILT) $(PRIVATE_BASE_PLAT_PRIVATE)
+endif # ($(PLATFORM_SEPOLICY_VERSION_TEST),true)
 endif # ($(PLATFORM_SEPOLICY_VERSION),$(TOT_SEPOLICY_VERSION))
 	$(hide) touch $@
 
-- 
2.17.1

